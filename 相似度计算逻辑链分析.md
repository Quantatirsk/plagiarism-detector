# æ–‡æ¡£ç›¸ä¼¼æ€§æ¯”è¾ƒé€»è¾‘é“¾åˆ†ææŠ¥å‘Š

## é—®é¢˜æè¿°

**æ ¸å¿ƒé—®é¢˜**: å‰ç«¯æ˜¾ç¤ºç›¸ä¼¼åº¦ä¸º72%ï¼Œä½†å®é™…ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ç»“æœä»…ä¸º0.58ï¼ˆ58%ï¼‰

**å½±å“**: ç”¨æˆ·çœ‹åˆ°çš„ç›¸ä¼¼åº¦æ•°å€¼ä¸å®é™…è®¡ç®—ç»“æœä¸åŒ¹é…ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯çš„åˆ¤æ–­

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```mermaid
graph TD
    A[ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£] --> B[APIæ¥æ”¶å¤„ç†]
    B --> C[æ–‡æ¡£è§£æä¸æ–‡æœ¬æå–]
    C --> D[æ–‡æœ¬åˆ†å‰²å¤„ç†]
    D --> E[å‘é‡åŒ–åµŒå…¥]
    E --> F[ç›¸ä¼¼åº¦æ£€ç´¢]
    F --> G[åŒå‘åŒ¹é…åˆå¹¶]
    G --> H[å‰ç«¯æ•°æ®å¤„ç†]
    H --> I[ç”¨æˆ·ç•Œé¢æ˜¾ç¤º]
```

---

## è¯¦ç»†é€»è¾‘é“¾æ¡åˆ†æ

### 1. APIå…¥å£ç‚¹åˆ†æ
**ä½ç½®**: `app/api/comparison.py`

**å…³é”®å‡½æ•°**: `upload_and_compare()`

```python
# ç¬¬83-91è¡Œï¼šæ‰§è¡Œå¯¹æ¯”é€»è¾‘
logger.info(f"Starting comparison with mode={mode}, threshold={threshold}")
detection_service = get_dual_detection_service()
result = await detection_service.compare_documents(
    doc1_path=doc1_path,
    doc2_path=doc2_path,
    mode=mode,
    paragraph_threshold=threshold,
    sentence_threshold=threshold  # ä½¿ç”¨ç›¸åŒé˜ˆå€¼
)
```

**å¤„ç†æµç¨‹**:
1. éªŒè¯ä¸Šä¼ æ–‡ä»¶æ ¼å¼å’Œå¤§å°
2. åˆ›å»ºä¸´æ—¶æ–‡ä»¶
3. è°ƒç”¨åŒæ–‡æ¡£æ£€æµ‹æœåŠ¡
4. è¿”å›å¯¹æ¯”ç»“æœ

---

### 2. åŒæ–‡æ¡£æ£€æµ‹æœåŠ¡åˆ†æ
**ä½ç½®**: `app/services/dual_document_detection.py`

**æ ¸å¿ƒæ–¹æ³•**: `compare_documents()`

```python
# ç¬¬64-88è¡Œï¼šæ ¸å¿ƒå¤„ç†é€»è¾‘
# 1. è§£ææ–‡æ¡£å†…å®¹
doc1_content = self.document_parser.parse_document(doc1_path)
doc2_content = self.document_parser.parse_document(doc2_path)

# 2. ç”Ÿæˆä¸´æ—¶æ–‡æ¡£ID
doc1_id = f"temp_doc1_{task_id}"
doc2_id = f"temp_doc2_{task_id}"

# 3. å‘é‡åŒ–å¹¶å­˜å‚¨ä¸¤ä¸ªæ–‡æ¡£
await self._vectorize_and_store_document(doc1_content, doc1_id)
await self._vectorize_and_store_document(doc2_content, doc2_id)

# 4. æ‰§è¡ŒåŒå‘æ£€æµ‹
doc1_matches = await self._detect_against_document(...)
doc2_matches = await self._detect_against_document(...)

# 5. åˆå¹¶å’Œå»é‡åŒ¹é…ç»“æœ
merged_matches = self._merge_bidirectional_matches(doc1_matches, doc2_matches)
```

**å¤„ç†æ­¥éª¤**:
1. æ–‡æ¡£è§£æå’Œå†…å®¹æå–
2. æ–‡æœ¬åˆ†å‰²ï¼ˆæ®µè½å’Œå¥å­ï¼‰
3. å‘é‡åŒ–åµŒå…¥å¹¶å­˜å‚¨åˆ°Milvus
4. åŒå‘ç›¸ä¼¼åº¦æ£€ç´¢ï¼ˆdoc1â†’doc2, doc2â†’doc1ï¼‰
5. ç»“æœåˆå¹¶å’Œå»é‡

---

### 3. å…³é”®ç›¸ä¼¼åº¦è®¡ç®—é€»è¾‘
**ä½ç½®**: `app/services/dual_document_detection.py` â†’ `_search_similar_in_document()`

```python
# ç¬¬278-298è¡Œï¼šå®é™…ç›¸ä¼¼åº¦æ£€ç´¢
results = await self.storage.search_similar(
    query_vector=query_embedding,
    top_k=10,
    filters=filter_expr
)

matches = []
for result in results:
    if result["similarity"] >= threshold:
        logger.info(f"Match found: similarity={result['similarity']:.4f}, threshold={threshold:.4f}")
        matches.append(SimilarityMatch(
            query_text=query_text,
            matched_text=result["content"],
            similarity_score=result["similarity"],  # âš ï¸ å…³é”®é—®é¢˜ç‚¹
            document_id=result["document_id"],
            query_document_id=query_document_id,
            position=position
        ))
```

---

### 4. Milvuså­˜å‚¨æœåŠ¡åˆ†æ
**ä½ç½®**: `app/services/storage.py`

**å…³é”®æ–¹æ³•**: `search_similar()`

```python
# ç¬¬182-184è¡Œï¼šç”Ÿäº§æ¨¡å¼ç›¸ä¼¼åº¦è®¡ç®—é…ç½®
search_params = {
    "metric_type": "COSINE",  # âš ï¸ ä½¿ç”¨ä½™å¼¦åº¦é‡
    "params": {"ef": max(64, top_k * 2)}
}

# ç¬¬187-206è¡Œï¼šæœç´¢å’Œç»“æœå¤„ç†
results = self.collection.search(...)
for hits in results:
    for hit in hits:
        matches.append({
            "similarity": hit.distance  # âš ï¸ æ ¸å¿ƒé—®é¢˜ï¼šdistanceä¸æ˜¯similarity
        })
```

**âš ï¸ å…³é”®é—®é¢˜å‘ç°**:
- Milvusä½¿ç”¨`COSINE`åº¦é‡æ—¶ï¼Œ`hit.distance`è¿”å›çš„æ˜¯**ä½™å¼¦è·ç¦»**ï¼Œä¸æ˜¯ä½™å¼¦ç›¸ä¼¼åº¦
- ä½™å¼¦è·ç¦» = 1 - ä½™å¼¦ç›¸ä¼¼åº¦
- ç³»ç»Ÿé”™è¯¯åœ°å°†ä½™å¼¦è·ç¦»ç›´æ¥å½“ä½œç›¸ä¼¼åº¦ä½¿ç”¨

---

### 5. å‰ç«¯æ˜¾ç¤ºé€»è¾‘åˆ†æ
**ä½ç½®**: `frontend/src/components/DocumentContentRenderer.tsx`

```typescript
// ç¬¬180è¡Œï¼šç›¸ä¼¼åº¦ç™¾åˆ†æ¯”æ˜¾ç¤º
const score = `${Math.round(similarity_score * 100)}%`;
```

**å¤„ç†æµç¨‹**:
1. æ¥æ”¶åç«¯çš„`similarity_score`
2. ç›´æ¥ä¹˜ä»¥100æ˜¾ç¤ºä¸ºç™¾åˆ†æ¯”
3. ä¸è¿›è¡Œä»»ä½•è½¬æ¢æˆ–æ ¡æ­£

---

## æ ¸å¿ƒé—®é¢˜åˆ†æ

### ğŸš¨ ä¸»è¦é—®é¢˜ï¼šä½™å¼¦è·ç¦»vsä½™å¼¦ç›¸ä¼¼åº¦æ··æ·†

**é—®é¢˜æè¿°**:
- **Milvusè¿”å›**: ä½™å¼¦è·ç¦»ï¼ˆCosine Distance = 1 - Cosine Similarityï¼‰
- **ç³»ç»Ÿå¤„ç†**: ç›´æ¥å½“ä½œä½™å¼¦ç›¸ä¼¼åº¦ä½¿ç”¨
- **å‰ç«¯æ˜¾ç¤º**: é”™è¯¯åœ°æ˜¾ç¤ºä¸ºç›¸ä¼¼åº¦ç™¾åˆ†æ¯”

**å…·ä½“æ¡ˆä¾‹åˆ†æ**:
- **å‰ç«¯æ˜¾ç¤º**: 72%ç›¸ä¼¼åº¦
- **å®é™…å«ä¹‰**: 0.72ä½™å¼¦è·ç¦»
- **çœŸå®ç›¸ä¼¼åº¦**: 1 - 0.72 = 0.28 = 28%
- **ç”¨æˆ·è®¡ç®—**: 0.58 = 58%

**å·®å¼‚æ¥æº**:
1. **ä¸»è¦é”™è¯¯**: ä½™å¼¦è·ç¦»è¯¯å½“ç›¸ä¼¼åº¦ (72% vs 28%)
2. **æ¬¡è¦å·®å¼‚**: æ–‡æœ¬é¢„å¤„ç†å·®å¼‚ (28% vs 58%)

---

### ğŸ“Š é€»è¾‘é“¾å®Œæ•´æ€§è¯„ä¼°

#### âœ… ç§‘å­¦åˆç†çš„éƒ¨åˆ†ï¼š
1. **å‘é‡åŒ–æ–¹æ³•**: ä½¿ç”¨Qwen3-Embedding-8Bæ¨¡å‹ï¼Œç»´åº¦4096
2. **ç›¸ä¼¼åº¦åº¦é‡**: ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œé€‚åˆæ–‡æœ¬è¯­ä¹‰æ¯”è¾ƒ
3. **åŒå‘æ£€æµ‹**: æé«˜åŒ¹é…è¦†ç›–ç‡ï¼Œé¿å…å•å‘é—æ¼
4. **é˜ˆå€¼è¿‡æ»¤**: å¯é…ç½®çš„ç›¸ä¼¼åº¦é˜ˆå€¼
5. **æ‰¹é‡å¤„ç†**: é«˜æ•ˆçš„å‘é‡åŒ–å’Œæ£€ç´¢

#### âŒ éœ€è¦ä¿®å¤çš„é—®é¢˜ï¼š
1. **æ ¸å¿ƒé”™è¯¯**: ä½™å¼¦è·ç¦»å½“ä½œç›¸ä¼¼åº¦ä½¿ç”¨
2. **æ•°æ®æ ‡ç­¾**: å­—æ®µå‘½åè¯¯å¯¼æ€§ï¼ˆdistanceå‘½åä¸ºsimilarityï¼‰
3. **éªŒè¯ç¼ºå¤±**: ç¼ºå°‘ç›¸ä¼¼åº¦è®¡ç®—çš„å•å…ƒæµ‹è¯•
4. **æ–‡æ¡£ç¼ºå¤±**: ç¼ºå°‘å‘é‡åº¦é‡çš„æŠ€æœ¯æ–‡æ¡£

#### âš ï¸ æ½œåœ¨æ”¹è¿›ç‚¹ï¼š
1. **æ–‡æœ¬é¢„å¤„ç†**: æ ‡å‡†åŒ–ç©ºæ ¼ã€æ ‡ç‚¹å¤„ç†å¯èƒ½å½±å“ä¸€è‡´æ€§
2. **å‘é‡å½’ä¸€åŒ–**: ç¡®ä¿å‘é‡æ­£ç¡®å½’ä¸€åŒ–
3. **æ‰¹å¤„ç†ç­–ç•¥**: å¤§æ–‡æ¡£çš„åˆ†å‰²å’Œå¤„ç†ç­–ç•¥
4. **ç¼“å­˜æœºåˆ¶**: é¿å…é‡å¤è®¡ç®—ç›¸åŒæ–‡æœ¬çš„å‘é‡

---

## ä¿®å¤å»ºè®®

### ğŸ”§ ç«‹å³ä¿®å¤ï¼ˆCriticalï¼‰

1. **ä¿®æ­£ç›¸ä¼¼åº¦è®¡ç®—**:
```python
# åœ¨storage.pyä¸­ä¿®å¤
"similarity": 1.0 - hit.distance  # ä»è·ç¦»è½¬æ¢ä¸ºç›¸ä¼¼åº¦
```

2. **æ·»åŠ éªŒè¯æµ‹è¯•**:
```python
def test_cosine_similarity_calculation():
    # æµ‹è¯•å·²çŸ¥å‘é‡çš„ç›¸ä¼¼åº¦è®¡ç®—
    assert abs(calculated_similarity - expected_similarity) < 0.01
```

### ğŸ”¨ ä¸­æœŸä¼˜åŒ–ï¼ˆImportantï¼‰

1. **ç»Ÿä¸€å­—æ®µå‘½å**: æ˜ç¡®åŒºåˆ†distanceå’Œsimilarity
2. **æ·»åŠ æŠ€æœ¯æ–‡æ¡£**: è¯´æ˜å‘é‡åº¦é‡å’Œè®¡ç®—é€»è¾‘
3. **å¢åŠ è°ƒè¯•å·¥å…·**: å®æ—¶æ˜¾ç¤ºè®¡ç®—è¿‡ç¨‹å’Œä¸­é—´ç»“æœ

### ğŸ¯ é•¿æœŸæ”¹è¿›ï¼ˆNice to haveï¼‰

1. **å¤šç§ç›¸ä¼¼åº¦åº¦é‡**: æ”¯æŒæ¬§å¼è·ç¦»ã€æ›¼å“ˆé¡¿è·ç¦»ç­‰
2. **è‡ªé€‚åº”é˜ˆå€¼**: åŸºäºæ–‡æ¡£ç‰¹å¾è‡ªåŠ¨è°ƒæ•´é˜ˆå€¼
3. **æ€§èƒ½ç›‘æ§**: å‘é‡è®¡ç®—æ€§èƒ½å’Œå‡†ç¡®æ€§ç›‘æ§

---

## ç»“è®º

**å½“å‰ç³»ç»Ÿå­˜åœ¨ä¸¥é‡çš„ç›¸ä¼¼åº¦è®¡ç®—é”™è¯¯**ï¼Œå°†Milvusè¿”å›çš„ä½™å¼¦è·ç¦»ç›´æ¥å½“ä½œç›¸ä¼¼åº¦ä½¿ç”¨ï¼Œå¯¼è‡´æ˜¾ç¤ºç»“æœå®Œå…¨é”™è¯¯ã€‚è¿™æ˜¯ä¸€ä¸ª**Criticalçº§åˆ«çš„bug**ï¼Œéœ€è¦ç«‹å³ä¿®å¤ã€‚

ä¿®å¤åï¼Œç³»ç»Ÿçš„ç§‘å­¦æ€§å’Œå‡†ç¡®æ€§å°†å¤§å¤§æå‡ï¼Œç”¨æˆ·çœ‹åˆ°çš„ç›¸ä¼¼åº¦å°†çœŸå®åæ˜ æ–‡æ¡£é—´çš„è¯­ä¹‰ç›¸ä¼¼ç¨‹åº¦ã€‚

**ä¼˜å…ˆçº§**: ğŸ”´ **ç«‹å³ä¿®å¤** - å½±å“æ ¸å¿ƒåŠŸèƒ½çš„æ­£ç¡®æ€§